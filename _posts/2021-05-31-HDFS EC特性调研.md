---
title: HDFS EC特性调研
date: 2021-05-31 00:00:00 +0800
categories: [大数据, 存储]
tags: [hdfs]
---

# HDFS EC存储调研报告


## 一、背景介绍


为了保证数据的可靠性，HDFS的默认数据存储策略是3副本，即在写入数据的时候，会占用该数据大小3倍的空间。这样就造成了大量的空间浪费。对此，HDFS引入在RAID磁盘阵列中已应用成熟的技术：EC（Erasure Coding，纠删码）。

EC的原理就是，通过将1个文件打散成很小的数据块（如128k、256k、1M等），然后将这些数据块打散存储于多个DN中，然后在另外的若干个DN中存储EC编解码算法生成的校验块。如果某个存储文件块的DN不可用后，将可以通过其他DN中存储的数据块和校验块反向计算出来这个丢失的数据块。

## 二、EC原理概要


不同的EC编解码算法、数据块大小、数据块和校验块个数，可以构成不同的EC策略。下面以 __RS-6-3-1024k__ 这种策略说明下EC策略的定义：

1、使用RS（Reed Solomon）编解码算法。

2、有6个DN用于存储数据块。

3、有3个DN存储校验块。

4、最大可以容忍3个块丢失的异常情况。

5、每个文件块的大小为1024k（即1MB）。

6、如果使用该EC策略存储的文件为100MB，则写入DataNode中的总数据量为(1 3/6) * 100MB=150MB。其中：

数据块总大小为文件大小100MB。

校验块总大小为3/6 * 100MB=50MB。

 __普通的3副本存储和EC存储的区别示意如下：__ 

 __普通的副本策略                                    EC存储策略__ 

![图片描述](/assets/media/HDFS EC特性调研/clip_image002.jpg)              ![图片描述](/assets/media/HDFS EC特性调研/clip_image004.jpg)

使用EC存储后，可以在提供相同可靠性的前提下，节省大量的存储空间。例如，要达到3副本相同的可靠性，仅需要1.5倍的原文件大小即可，从而节约一半的存储空间（原先需要3倍的原文件大小）。

 __说明：__ 

1、HDFS内置的EC编解码算法有：XOR（异或）、RS-LEGACY（旧版Reed-Solomon，性能较差，不建议使用）、RS（新版Reed-Solomon，性能是RS-LEGACY的5倍）。

2、HDFS内置的EC策略有：RS-3-2-1024k，RS-6-3-1024k，RS-10-4-1024k，RS-LEGACY-6-3-1024k，XOR-2-1-1024k。

3、HDFS支持通过客户端命令添加自定义EC策略。

4、仅支持对目录设置EC策略，不能对文件设置EC策略。

5、给某个目录设置EC策略后，该目录下的所有未设置EC策略的目录都会继承该目录的EC策略。

## 三、测试过程


### 1. 列出当前集群中所有支持的EC编解码算法![图片描述](/assets/media/HDFS EC特性调研/clip_image006.jpg)


### 2. 列出当前集群中所有的EC策略


![图片描述](/assets/media/HDFS EC特性调研/clip_image008.jpg)

### 3. 启用指定的EC策略(指定为XOR-2-1-1024k)


![图片描述](/assets/media/HDFS EC特性调研/clip_image010.jpg)

### 4. 设置目录的EC策略


hdfs
ec -setPolicy -path &lt;path&gt; [-policy &lt;policy&gt;] [-replicate]

![图片描述](/assets/media/HDFS EC特性调研/clip_image012.jpg)

说明： __hdfs ec -setPolicy__ 
 __-path &lt;path&gt; [-policy &lt;policy&gt;] [-replicate]__ 

备注：(只有启用（ENABLED）状态的EC策略，才能设置给目录。)

### 5. 向开启EC策略的目录写入数据


写入本地892M的jar包数据

![图片描述](/assets/media/HDFS EC特性调研/clip_image014.jpg)

查看写入数据的大小

![图片描述](/assets/media/HDFS EC特性调研/clip_image016.jpg)

### 6. 查看/tmp/test开启EC后的block的分布


![图片描述](/assets/media/HDFS EC特性调研/clip_image018.jpg)

·       
可见890.3M的文件被分为4个block group,其中3个block
group为256M，1个block group为122.3M。 

·       
每个block group保存2份原始数据，按默认的block size为128MB，计算3个数据文件为256MB，所以一共4个block
group，最后一个block group不够256MB。

·       
Live_repl=3，表明此数据块有3个副本，2个是原始数据，1个是校验数据，这里我们选择的纠删码策略是XOR(2,1)，与策略一致。只是这里原始文件大很多，每个副本为128MB，包含128个1MB的cell。

## 四、一些问题思考


### 1. EC策略的一些问题与限制


1)、文件在存储时被打散到多个DN中，文件读取不再有“本地读”的概念，容易引发严重的数据倾斜。

2)、写入文件时，都需要计算（生成校验块、或通过校验块校验），这会消耗更多CPU

3)、在DN节点不可用时，需要通过计算得到缺失的数据块，这会消耗更多CPU，使复杂度增高、异常恢复时间更长。

4)、客户端在读写文件时，需要同时连接所有涉及的DN读写数据块和校验块。

5)、因为实现的原因，目前不支持2个基本的FileSystem接口：append()、truncate()，调用会直接抛异常。不同EC策略的文件的concat()，也会抛错。

 

### 2. EC特性适用性分析


针对这些限制和问题，该特性更适用于一次写入大量数据的场景，不太适用于以下的场景：

1)、大量小文件

2)、数据量很小的文件

3)、打开后长期持续写入的文件

4)、需要调用append()或truncate()接口修改的文件

### 3. 针对系统的影响


1)、相比副本存储，EC存储对系统有如下影响：

2)、NameNode、DataNode、客户端都需要消耗更多的CPU、内存、网络资源。

3)、DataNode异常后，需要更长时间来恢复该DataNode上的数据，同时也会降低相关文件的读取性能。

### 4. 开启EC策略后的一些集群参数建议


1)、调大NameNode、DataNode的“GC_OPTS”中内存参数（主要是-Xmx的值）。

2)、调大HDFS客户端及依赖于HDFS的上层组件的内存参数。

3)、调大DataNode的数据连接线程数参数“dfs.datanode.max.transfer.threads”。

### 5. 结实际生产环境讨论EC适用性


生产环境hdfs路径分布图示

![图片描述](/assets/media/HDFS EC特性调研/clip_image020.jpg)

当前生产环境主节点机器受限，namenode几乎无法扩充内存

生产环境小于1M小文件数千万级别

由此当前生产集群对EC支持不是很友好。

## 附录:hdfs推荐EC策略介绍


### 1. RS-10-4-1024k


使用RS编码，每10个数据单元（cell），生成4个校验单元，共14个单元，也就是说：这14个单元中，只要有任意的10个单元存在（不管是数据单元还是校验单元，只要总数=10），就可以得到原始数据。每个单元的大小是1024k=1024*1024=1048576B。

 

### 2. RS-3-2-1024k


使用RS编码，每3个数据单元，生成2个校验单元，共5个单元，也就是说：这5个单元中，只要有任意的3个单元存在（不管是数据单元还是校验单元，只要总数=3），就可以得到原始数据。每个单元的大小是1024k=1024*1024=1048576B。

 

### 3. RS-6-3-1024k


使用RS编码，每6个数据单元，生成3个校验单元，共9个单元，也就是说：这9个单元中，只要有任意的6个单元存在（不管是数据单元还是校验单元，只要总数=6），就可以得到原始数据。每个单元的大小是1024k=1024*1024=1048576B。

 

### 4. RS-LEGACY-6-3-1024k


策略和上面的RS-6-3-1024k一样，只是编码的算法用的是rs-legacy，应该是之前遗留的rs算法。

 

### 5. XOR-2-1-1024k


使用XOR编码（速度比RS编码快），每2个数据单元，生成1个校验单元，共3个单元，也就是说：这3个单元中，只要有任意的2个单元存在（不管是数据单元还是校验单元，只要总数=2），就可以得到原始数据。每个单元的大小是1024k=1024*1024=1048576B。

 

 

以RS-6-3-1024k为例，6个数据单元 3个校验单元，可以容忍任意的3个单元丢失，冗余的数据是50%。而采用副本方式，3个副本，冗余200%，却还不能容忍任意的3个单元丢失。因此，RS编码在相同冗余度的情况下，会大大提升数据的可用性，而在相同可用性的情况下，会大大节省冗余空间。