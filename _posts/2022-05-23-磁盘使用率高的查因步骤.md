---
title: 磁盘使用率高的查因步骤
date: 2022-05-23 00:00:00 +0800
categories: ['大数据']
tags: ['故障处理']
---

# 【故障处理】磁盘使用率高的查因步骤

可能性1:
1. 通过堡垒机登录目标机器，执行`df -h`查看磁盘使用率信息。
![图片描述](/assets/media/故障处理磁盘使用率高的查因步骤/tapd_48728548_1593658302_48.png)
2. 如上图，发现`/data`路径使用率比较高，则执行`du -h -d 1 /data`扫描下面哪个路径占用空间过多。-d是限定扫描的深度。
![图片描述](/assets/media/故障处理磁盘使用率高的查因步骤/tapd_48728548_1593658288_35.png)
3.  扫描发现`df`和`du`有1个多T的差额，应该是有文件删除掉，但是进程还在占用状态，删除文件未释放导致。执行`lsof /data| grep deleted`查看路径下删除文件的关联进程及大小信息。
![图片描述](/assets/media/故障处理磁盘使用率高的查因步骤/tapd_48728548_1593658302_48.png)
4. `lsof`默认显示的大小是`byte`单位，不是给人看的，需要加上`lsof  /data | grep deleted |  awk '{$7=$7/1048576 "MB"}1'`这种操作，计算MB的值，方便查阅。
![图片描述](/assets/media/故障处理磁盘使用率高的查因步骤/tapd_48728548_1593658503_46.png)
5. 查出来是某个`yarn`应用的日志打太多了，运营群里问一下，拉开发私聊优化解决。

Over

可能性2:
1. 如果是dn节点根目录的磁盘有使用率高的问题，且检查可能性1后未发现占用空间多的问题，大概率是可能性2，按照以下步骤排查。
2. 可能性2的主要原因是：节点之前可能存在路径d，以及下面的文件f，但是后面将磁盘挂载到路径d上了，这时，文件f不会丢失掉，而且不会体现在du中，各种方法都扫描不出文件f的。
3. 创建临时路径`/tmp/oldroot`
4. 将根目录bind到临时路径下`mount --bind / /tmp/oldroot`
5. 然后再`/tmp/oldroot`里执行`du -h -d 1 .`找到大的路径/文件
6. 处理完毕，最后再umount /tmp/oldroot即可