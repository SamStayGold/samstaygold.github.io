---
title: 大数据私有源-解包，打包和改造
date: 2023-10-10 19:29 +0800
categories: [大数据, HDP]
tags: [HDP]
---

# 背景

因为2021年末闹得风风火火的log4j漏洞，大数据这边使用的组件很多都中招了。现时生产环境使用的HDP 3.1.0版本，有Druid和Hive两个组件使用了问题版本的log4j.jar包，这些jar包可以在组件安装后进行jndi class的删除操作，但是在新节点添加时，是从私有源中拉取的官方rpm包，里面包含的log4j还是没有修复的版本，因此，有必要对私有源中的rpm包进行解包，改造，并重新打包使用。另外，未来生产环境的Presto，Clickhouse也将以rpm包的方式安装。其中，presto也需要针对其init.d服务控制文件进行定制，来方便amabri接入，也需要修复plugin中的log4j的jar包，保证扩容后的漏洞风险控制。

这些需求，要求我们掌握rpm的解包，打包能力，也要求我们熟悉yum源，熟悉更新rpm包后yum源的适配更新方式。

# rpm简介

RPM（Redhat Package Manager）是用于Redhat、CentOS、Fedora等Linux 分发版（distribution）的常见的软件包管理器。因为它允许分发已编译的软件，所以用户只用一个命令就可以安装软件。

完整的rpm打包的时候需要编译源码，还需要把编译好的配置文件啊二进制命令文件啊之类的东西按照安装好的样子放到合适的位置，还要根据需要对RPM的包进行测试，这些都需要先有一个“工作空间”。而rpm打包使用的`rpmbuild`命令使用一套标准化的“工作空间”。

[rpm使用的路径介绍](https://www.notion.so/d7e4709b56d04adaaaee86cde9eab882)

打包的过程有点像是流水线，分好几个工序：
 1. 首先，需要把源代码放到`%_sourcedir`中；
 2. 然后，进行编译，编译的过程是在`%_builddir`中完成的，所以需要先把源代码复制到这个目录下边，一般情况下，源代码是压缩包格式，那么就解压过来即可；
 3. 第三步，进行“安装”，这里有点类似于预先组装软件包，把软件包应该包含的内容（比如二进制文件、配置文件、man文档等）复制到`%_buildrootdir`中，并按照实际安装后的目录结构组装，比如二进制命令可能会放在/usr/bin下，那么就在`%_buildrootdir`下也按照同样的目录结构放置；
 4. 然后，需要配置一些必要的工作，比如在实际安装前的准备啦，安装后的清理啦，以及在卸载前后要做的工作啦等等，这样也都是通过配置在SPEC文件中来告诉`rpmbuild`命令；
 5. 还有一步可选操作，那就是检查软件是否正常运行；
 6. 最后，生成的RPM包放置到`%_rpmdir`，源码包放置到`%_srpmdir`下。

这里，我们最需要关注的还是`%_buildrootdir`以及SPEC文件，因为我们是直接针对RPM解包操作的，也就相当于反向进行了从预组装的软件到rpm包的过程。

# RPM解包，SPEC文件解析，重新打包

解包RPM其实包含两个过程：

1. 反编译提取SPEC文件
2. 解压缩RPM生成`%_buildrootdir`路径
3. 重新打包成rpm

我们一步一步介绍。

## 反编译提取SPEC文件

这里需要使用一个非常好用的工具`rpmrebuild`，如果有装`epel-release`源的话，可以直接使用`yum install rpmrebuild`，如果没有，请自行谷歌下`epel`源的安装方式。

使用`rpmrebuild -e -p rpm-package-name.rpm`命令，来解析rpm包的SPEC文件。这时会打开一个vim界面，不过文件是存在临时路径下的，可以使用vim的`w 目标文件名`的命令将文件另存为一个SPEC文件。

## 解压缩RPM

这一步使用`rpm2cpio rpm-package-name.rpm |cpio -idv`命令来将rpm包解压到当前路径，注意，最好将rpm放到一个专门的路径中解压，防止和其他路径弄混。

## 重新打包

这一步使用`rpmbuild -bb rpm-package-name.spec`的命令来重新打包，注意，打包的路径需要满足之前提到的rpmbuild标准化的“工作空间”的要求。

下面以hive的hive_3_1_0_0_78-jdbc-3.1.0.3.1.0.0-78.noarch.rpm为例，具体介绍下解包流程，SPEC文件的介绍，以及重新打包的流程。

```bash
# 手动创建打包路径
mkdir -p /data/rpmbuild/{BUILD_TMP,BUILDROOT,RPMS,SPECS,SRPMS} 

# 将对应rpm包拷贝进入BUILD_TMP路径中
cp /var/www/html/hdp/HDP/centos7/3.1.0.0-78/hive/hive_3_1_0_0_78-jdbc-3.1.0.3.1.0.0-78.noarch.rpm /data/rpmbuild/BUILD_TMP/

# 配置rpm的编译目录
vim ~/.rpmmacros
# 在里面添加以下字段，保存
%_topdir /data/rpmbuild

# 反编译解析SPEC文件，存入SPECS路径中
cd /data/rpmbuild/BUILD_TMP
rpmrebuild -e -p hive_3_1_0_0_78-jdbc-3.1.0.3.1.0.0-78.noarch.rpm
shift+: w /data/rpmbuild/SPECS/hive_3_1_0_0_78-jdbc-3.1.0.3.1.0.0-78.spec
# 退出反编译界面，在后面的提示中选择N，不继续进行自动重新打包
Do you want to continue ? (y/N) N
```

这时，我们就获得了`hive_3_1_0_0_78-jdbc-3.1.0.3.1.0.0-78.noarch.rpm`的spec文件，一起来看看吧。

```bash
# 这里标记是rpmrebuild自动生产的spec文件
# rpmrebuild autogenerated specfile

# 这里定义了rpmbuild的编译目录，需要修改成/data/rpmbuild/BUILDROOT
BuildRoot: /root/.tmp/rpmrebuild.31599/work/root
AutoProv: no
%undefine __find_provides
AutoReq: no
%undefine __find_requires
# Do not try autogenerate prereq/conflicts/obsoletes and check files
%undefine __check_files
%undefine __find_prereq
%undefine __find_conflicts
%undefine __find_obsoletes
# Be sure buildpolicy set to do nothing
%define __spec_install_post %{nil}
# Something that need for rpm-4.1
%define _missing_doc_files_terminate_build 0
#dummy
#dummy
#BUILDHOST:    ctr-e138-1518143905142-586755-01-000015.hwx.site
#BUILDTIME:    Thu Dec  6 20:38:01 2018
#SOURCERPM:    hive_3_1_0_0_78-3.1.0.3.1.0.0-78.src.rpm
#RPMVERSION:   4.11.3
#OS:           linux
#SIZE:           208774479
#ARCHIVESIZE:           208777900
#ARCH:         noarch
#这边定义了打包的类型，noarch是通用的二进制文件包，此外还有x86_64等类型，下面还有其他介绍
BuildArch:     noarch
Name:          hive_3_1_0_0_78-jdbc
Version:       3.1.0.3.1.0.0
Release:       78
License:       Apache License v2.0
Group:         Development/Libraries
Summary:       Provides libraries necessary to connect to Apache Hive via JDBC
URL:           http://hive.apache.org/

#这里明确了这个rpm能够安装组件还有依赖的组件
Provides:      hive_3_1_0_0_78-jdbc = 3.1.0.3.1.0.0-78
Provides:      osgi(org.apache.logging.log4j.1.2-api) = 2.10.0
Provides:      osgi(org.apache.logging.log4j.api) = 2.10.0
Provides:      osgi(org.apache.logging.log4j.core) = 2.10.0
Provides:      osgi(org.apache.logging.log4j.slf4j-impl) = 2.10.0
Provides:      osgi(org.apache.logging.log4j.web) = 2.10.0
Provides:      osgi(org.apache.thrift) = 0.9.3
Requires:      atlas-metadata_3_1_0_0_78-hive-plugin
Requires:      hadoop_3_1_0_0_78-client
#Requires:      rpmlib(CompressedFileNames) <= 3.0.4-1
#Requires:      rpmlib(FileDigests) <= 4.6.0-1
#Requires:      rpmlib(PayloadFilesHavePrefix) <= 4.0-1
#Requires:      rpmlib(PayloadIsXz) <= 5.2-1
#suggest
#enhance
%description
This package provides libraries necessary to connect to Apache Hive via JDBC
# 这里定义哪些文件或目录会放入rpm中，也标记了这个rpm安装的时候会解压到的位置
%files
%attr(0644, root, root) "/usr/hdp/3.1.0.0-78/hive/jdbc/hive-jdbc-3.1.0.3.1.0.0-78-standalone.jar"
%dir %attr(0755, root, root) "/usr/hdp/3.1.0.0-78/hive/lib"
%attr(0644, root, root) "/usr/hdp/3.1.0.0-78/hive/lib/commons-logging-1.0.4.jar"
%attr(0644, root, root) "/usr/hdp/3.1.0.0-78/hive/lib/hive-exec-3.1.0.3.1.0.0-78.jar"
%attr(0644, root, root) "/usr/hdp/3.1.0.0-78/hive/lib/hive-jdbc-3.1.0.3.1.0.0-78.jar"
%attr(0644, root, root) "/usr/hdp/3.1.0.0-78/hive/lib/hive-jdbc-handler-3.1.0.3.1.0.0-78.jar"
%attr(0777, root, root) "/usr/hdp/3.1.0.0-78/hive/lib/hive-jdbc-handler.jar"
%attr(0644, root, root) "/usr/hdp/3.1.0.0-78/hive/lib/hive-metastore-3.1.0.3.1.0.0-78.jar"
%attr(0644, root, root) "/usr/hdp/3.1.0.0-78/hive/lib/hive-serde-3.1.0.3.1.0.0-78.jar"
%attr(0644, root, root) "/usr/hdp/3.1.0.0-78/hive/lib/hive-service-3.1.0.3.1.0.0-78.jar"
%attr(0644, root, root) "/usr/hdp/3.1.0.0-78/hive/lib/hive-service-rpc-3.1.0.3.1.0.0-78.jar"
%attr(0777, root, root) "/usr/hdp/3.1.0.0-78/hive/lib/hive-service-rpc.jar"
%attr(0644, root, root) "/usr/hdp/3.1.0.0-78/hive/lib/libfb303-0.9.3.jar"
%attr(0644, root, root) "/usr/hdp/3.1.0.0-78/hive/lib/libthrift-0.9.3.jar"
%attr(0644, root, root) "/usr/hdp/3.1.0.0-78/hive/lib/log4j-1.2-api-2.10.0.jar"
%attr(0644, root, root) "/usr/hdp/3.1.0.0-78/hive/lib/log4j-api-2.10.0.jar"
%attr(0644, root, root) "/usr/hdp/3.1.0.0-78/hive/lib/log4j-core-2.10.0.jar"
%attr(0644, root, root) "/usr/hdp/3.1.0.0-78/hive/lib/log4j-slf4j-impl-2.10.0.jar"
%attr(0644, root, root) "/usr/hdp/3.1.0.0-78/hive/lib/log4j-web-2.10.0.jar"
%changelog

# 因为这个是非常简单的rpm包，因此没有以下几类操作，如果有的话，可以按需处理
# %pre   rpm安装前执行的脚本
# %post rpm安装后执行的脚本
# %preun   rpm卸载前执行的脚本
# %postun rpm卸载后执行的脚本
```

接下来开始解压rpm包，配置编译目录

```bash
# 解压rpm包
cd /data/rpmbuild/BUILD_TMP
rpm2cpio hive_3_1_0_0_78-jdbc-3.1.0.3.1.0.0-78.noarch.rpm |cpio -idv
# 这一步会在BUILD_TMP下生成usr路径，就是上面spec文件里提到的一系列文件

# 针对log4j-core进行改造
cd /data/rpmbuild/BUILD_TMP/usr/hdp/3.1.0.0-78/hive/lib
zip -q -d log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class

# 尝试build一下spec，确认build需要的目录名
rpmbuild -bb /data/rpmbuild/SPECS/hive_3_1_0_0_78-jdbc-3.1.0.3.1.0.0-78.spec
# 这里会报错File not found: /data/rpmbuild/BUILDROOT/hive_3_1_0_0_78-jdbc-3.1.0.3.1.0.0-78.x86_64/usr/hdp/3.1.0.0-78/hive/lib/log4j-1.2-api-2.10.0.jar之类
# hive_3_1_0_0_78-jdbc-3.1.0.3.1.0.0-78.x86_64就是我们需要的目录名，在/data/rpmbuild/BUILDROOT中建好hive_3_1_0_0_78-jdbc-3.1.0.3.1.0.0-78.x86_64目录，将/data/rpmbuild/BUILD_TMP里的usr路径拷贝过去。/data/rpmbuild/BUILDROOT每次build完成后都会清空，所以一定要留一份。
mkdir -p /data/rpmbuild/BUILDROOT/hive_3_1_0_0_78-jdbc-3.1.0.3.1.0.0-78.x86_64
cp -R /data/rpmbuild/BUILD_TMP/usr /data/rpmbuild/BUILDROOT/hive_3_1_0_0_78-jdbc-3.1.0.3.1.0.0-78.x86_64/

# 重新打包，这里只打包二进制文件也就是-bb参数
rpmbuild -bb /data/rpmbuild/SPECS/hive_3_1_0_0_78-jdbc-3.1.0.3.1.0.0-78.spec

# 这时就可以在/data/rpmbuild/RPMS/noarch中看打包好的文件了
ll /data/rpmbuild/RPMS/noarch
rpm -qpi /data/rpmbuild/RPMS/noarch/hive_3_1_0_0_78-jdbc-3.1.0.3.1.0.0-78.noarch.rpm

Name        : hive_3_1_0_0_78-jdbc
Version     : 3.1.0.3.1.0.0
Release     : 78
Architecture: noarch
Install Date: (not installed)
Group       : Development/Libraries
Size        : 208755931
License     : Apache License v2.0
Signature   : (none)
Source RPM  : hive_3_1_0_0_78-jdbc-3.1.0.3.1.0.0-78.src.rpm
Build Date  : Wed 22 Dec 2021 05:06:36 PM CST
Build Host  : bhdtest001.dev.com
Relocations : (not relocatable)
URL         : http://hive.apache.org/
Summary     : Provides libraries necessary to connect to Apache Hive via JDBC
Description :
This package provides libraries necessary to connect to Apache Hive via JDBC

# 和源里的rpm做下对比
rpm -qpi /var/www/html/hdp/HDP/centos7/3.1.0.0-78/hive/hive_3_1_0_0_78-jdbc-3.1.0.3.1.0.0-78.noarch.rpm

Name        : hive_3_1_0_0_78-jdbc
Version     : 3.1.0.3.1.0.0
Release     : 78
Architecture: noarch
Install Date: (not installed)
Group       : Development/Libraries
Size        : 208774479
License     : Apache License v2.0
Signature   : RSA/SHA1, Thu 06 Dec 2018 08:44:32 PM CST, Key ID b9733a7a07513cad
Source RPM  : hive_3_1_0_0_78-3.1.0.3.1.0.0-78.src.rpm
Build Date  : Thu 06 Dec 2018 08:38:01 PM CST
Build Host  : ctr-e138-1518143905142-586755-01-000015.hwx.site
Relocations : (not relocatable)
URL         : http://hive.apache.org/
Summary     : Provides libraries necessary to connect to Apache Hive via JDBC
Description :
This package provides libraries necessary to connect to Apache Hive via JDBC
```

这样，解包，修改，重新打包就完成了。更高级的操作，包括对spec文件进行更新修改等等，这里先不涉及，等后面遇到高级操作再慢慢补充。

# yum源的更新流程

rpm包是准备完成了，但是，要让以后新增的节点正常使用rpm包，需要替换rpm包，并更新大数据私有源的元数据。

在创建HDP集群时，我们使用createrepo命令建了私有源`createrepo /var/www/html/hdp/HDP/centos7/`

在变更里面的rpm文件后，需要使用更新命令更新元数据

```bash
# 备份rpm包, 替换rpm包，更新权限
mkdir ~/rpm_old
mv /var/www/html/hdp/HDP/centos7/3.1.0.0-78/hive/hive_3_1_0_0_78-jdbc-3.1.0.3.1.0.0-78.noarch.rpm ~/rpm_old
cp /data/rpmbuild/RPMS/noarch/hive_3_1_0_0_78-jdbc-3.1.0.3.1.0.0-78.noarch.rpm /var/www/html/hdp/HDP/centos7/3.1.0.0-78/hive/
chmod 755 /var/www/html/hdp/HDP/centos7/3.1.0.0-78/hive/hive_3_1_0_0_78-jdbc-3.1.0.3.1.0.0-78.noarch.rpm
chown atuser:users /var/www/html/hdp/HDP/centos7/3.1.0.0-78/hive/hive_3_1_0_0_78-jdbc-3.1.0.3.1.0.0-78.noarch.rpm

# 更新repo元数据
createrepo —update /var/www/html/hdp/HDP/centos7/
# 因为机器配置了umask，要记得改下repodata的读取权限
chmod -R 755 /var/www/html/hdp/HDP/centos7/3.1.0.0-78/repodata
```

最后我们测试下rpm的效果

```bash
# 检查log4j的文件
ll /usr/hdp/3.1.0.0-78/hive/lib/ | grep log4j
-rw-r--r-- 1 root root    63835 Dec  1  2018 log4j-1.2-api-2.10.0.jar
-rw-r--r-- 1 root root   255485 Dec  1  2018 log4j-api-2.10.0.jar
-rw-r--r-- 1 root root  1597622 Dec  1  2018 log4j-core-2.10.0.jar.bak.20211216
-rw-r--r-- 1 root root  1579074 Dec 16 17:34 log4j-core-2.10.0.sam-20211216.jar
-rw-r--r-- 1 root root    24173 Dec  1  2018 log4j-slf4j-impl-2.10.0.jar
-rw-r--r-- 1 root root    32060 Dec  1  2018 log4j-web-2.10.0.jar

# 确认rpm包名
rpm -qa | grep hive
hive_3_1_0_0_78-3.1.0.3.1.0.0-78.noarch
hive_3_1_0_0_78-jdbc-3.1.0.3.1.0.0-78.noarch
ranger_3_1_0_0_78-hive-plugin-1.2.0.3.1.0.0-78.x86_64
atlas-metadata_3_1_0_0_78-hive-plugin-1.1.0.3.1.0.0-78.noarch

# 删除hive-jdbc
yum search hive
yum remove hive_3_1_0_0_78-jdbc.noarch

# 这里一并删除了hive的大lib本身，需要重新安装
yum install hive

# 检查重新安装后的log4j文件
ll /usr/hdp/3.1.0.0-78/hive/lib/ | grep log4j
-rw-r--r-- 1 root root    63835 Dec 22 17:05 log4j-1.2-api-2.10.0.jar
-rw-r--r-- 1 root root   255485 Dec 22 17:05 log4j-api-2.10.0.jar
-rw-r--r-- 1 root root  1579074 Dec 22 17:05 log4j-core-2.10.0.jar
-rw-r--r-- 1 root root  1597622 Dec  1  2018 log4j-core-2.10.0.jar.bak.20211216
-rw-r--r-- 1 root root  1579074 Dec 16 17:34 log4j-core-2.10.0.sam-20211216.jar
-rw-r--r-- 1 root root    24173 Dec 22 17:05 log4j-slf4j-impl-2.10.0.jar
-rw-r--r-- 1 root root    32060 Dec 22 17:05 log4j-web-2.10.0.jar

# 可以看到新的log4jcore都是重新打包好的了
```

# 总结

本次调研，我们找到了HDP的RPM包解包，修改，重新打包的方法。presto，clickhouse等其他rpm包也类似。我们可以通过这个流程，自定义包内的jar版本，或者配置文件等，来处理简化log4j的漏洞修复，以及其他需求。